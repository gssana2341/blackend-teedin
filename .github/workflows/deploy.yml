name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Deploy to Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 34.158.61.147 >> ~/.ssh/known_hosts

          # Deploy on server
          echo ">>> Connecting to server and deploying..."
          ssh -i ~/.ssh/deploy_key teedineasy_team@34.158.61.147 << 'EOF'
            set -e
            
            echo ">>> Navigating to project directory..."
            cd $HOME/teedin-backend
            
            echo ">>> Pulling latest code from GitHub..."
            git pull origin main
            
            echo ">>> Stopping existing containers..."
            docker compose -f docker-compose.prod.yml down || true
            
            echo ">>> Building Docker images..."
            docker compose -f docker-compose.prod.yml build --no-cache
            
            echo ">>> Starting containers..."
            docker compose -f docker-compose.prod.yml up -d
            
            echo ">>> Waiting for services to start..."
            sleep 30
            
            echo ">>> Checking container status..."
            docker compose -f docker-compose.prod.yml ps
            
            echo ">>> Checking logs..."
            docker compose -f docker-compose.prod.yml logs --tail=50 teedin-backend
            
            echo ">>> Deployment completed!"
            echo "ðŸŽ‰ API is available at: http://34.158.61.147:3001"
          EOF
